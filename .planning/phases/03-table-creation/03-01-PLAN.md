---
phase: 03-table-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/gdpdu_table_creator.hpp, src/gdpdu_table_creator.cpp, src/CMakeLists.txt]
autonomous: true

must_haves:
  truths:
    - "create_tables function takes GdpduSchema and DuckDB connection"
    - "Tables are created with DROP TABLE IF EXISTS before CREATE"
    - "Column types use gdpdu_type_to_duckdb_type mapping"
    - "All columns from TableDef are created in correct order"
  artifacts:
    - path: "src/gdpdu_table_creator.hpp"
      provides: "Table creation interface for DuckDB"
      min_lines: 15
      contains: "create_tables"
    - path: "src/gdpdu_table_creator.cpp"
      provides: "Table creation implementation using DuckDB API"
      min_lines: 50
      contains: "DROP TABLE"
  key_links:
    - from: "src/gdpdu_table_creator.cpp"
      to: "src/gdpdu_schema.hpp"
      via: "consumes TableDef and ColumnDef structures"
      pattern: "#include.*gdpdu_schema"
    - from: "src/gdpdu_table_creator.cpp"
      to: "duckdb"
      via: "executes SQL via Connection"
      pattern: "Connection"
---

<objective>
Create DuckDB tables from parsed GDPdU schema definitions.

Purpose: Take GdpduSchema (populated by the parser) and create corresponding tables in DuckDB â€” with correct column names and types, dropping existing tables first.

Output: Table creator module that creates all tables defined in a GdpduSchema; integrated into extension build.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Schema structures (from Phase 2 Plan 01):
@src/gdpdu_schema.hpp
@src/gdpdu_schema.cpp

Extension entry point:
@src/gdpdu_extension.cpp

CMake configuration:
@src/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement table creator module</name>
  <files>src/gdpdu_table_creator.hpp, src/gdpdu_table_creator.cpp</files>
  <action>
Create the table creation module that generates DuckDB tables from GdpduSchema.

**src/gdpdu_table_creator.hpp**:

```cpp
#pragma once

#include "gdpdu_schema.hpp"
#include "duckdb.hpp"

namespace duckdb {

// Result of creating a single table
struct TableCreateResult {
    std::string table_name;
    int column_count;
    bool success;
    std::string error_message;  // Empty if success
    
    TableCreateResult() : column_count(0), success(false) {}
};

// Create all tables from schema in the given connection
// Drops existing tables before creating new ones
// Returns vector of results for each table
std::vector<TableCreateResult> create_tables(Connection& conn, const GdpduSchema& schema);

// Create a single table from TableDef
// Returns result with success/error info
TableCreateResult create_table(Connection& conn, const TableDef& table);

// Generate CREATE TABLE SQL statement for a table
std::string generate_create_table_sql(const TableDef& table);

} // namespace duckdb
```

**src/gdpdu_table_creator.cpp**:

1. Include headers:
   - `"gdpdu_table_creator.hpp"`
   - `"gdpdu_schema.hpp"`
   - `<sstream>`

2. Implement `generate_create_table_sql(table)`:
   ```cpp
   std::string generate_create_table_sql(const TableDef& table) {
       std::ostringstream sql;
       sql << "CREATE TABLE \"" << table.name << "\" (";
       
       bool first = true;
       for (const auto& col : table.columns) {
           if (!first) sql << ", ";
           first = false;
           
           // Quote column name to handle special chars like "VAT%"
           sql << "\"" << col.name << "\" " << gdpdu_type_to_duckdb_type(col);
       }
       
       sql << ")";
       return sql.str();
   }
   ```

3. Implement `create_table(conn, table)`:
   ```cpp
   TableCreateResult create_table(Connection& conn, const TableDef& table) {
       TableCreateResult result;
       result.table_name = table.name;
       result.column_count = table.columns.size();
       
       try {
           // Drop existing table first
           std::string drop_sql = "DROP TABLE IF EXISTS \"" + table.name + "\"";
           conn.Query(drop_sql);
           
           // Create new table
           std::string create_sql = generate_create_table_sql(table);
           auto query_result = conn.Query(create_sql);
           
           if (query_result->HasError()) {
               result.success = false;
               result.error_message = query_result->GetError();
           } else {
               result.success = true;
           }
       } catch (const std::exception& e) {
           result.success = false;
           result.error_message = e.what();
       }
       
       return result;
   }
   ```

4. Implement `create_tables(conn, schema)`:
   ```cpp
   std::vector<TableCreateResult> create_tables(Connection& conn, const GdpduSchema& schema) {
       std::vector<TableCreateResult> results;
       results.reserve(schema.tables.size());
       
       for (const auto& table : schema.tables) {
           results.push_back(create_table(conn, table));
       }
       
       return results;
   }
   ```

**Important Notes**:
- Always quote table and column names with double quotes to handle:
  - Reserved words (e.g., "Name", "Description")
  - Special characters (e.g., "VAT%", "StraightLine%")
  - German characters (e.g., "Beschreibung")
- Use DROP TABLE IF EXISTS for idempotent imports
- Return structured results so caller can report success/failure per table
  </action>
  <verify>Files compile without errors when included in extension</verify>
  <done>Table creator module implemented with create_tables, create_table, and generate_create_table_sql functions</done>
</task>

<task type="auto">
  <name>Task 2: Update CMake and verify build</name>
  <files>src/CMakeLists.txt</files>
  <action>
Update CMake to include the new table creator source file.

**src/CMakeLists.txt**:
Add gdpdu_table_creator.cpp to the EXTENSION_SOURCES list:

```cmake
set(EXTENSION_SOURCES
    gdpdu_extension.cpp
    gdpdu_schema.cpp
    gdpdu_table_creator.cpp
)
```

**Build verification**:
1. Run `cmake -B build -DCMAKE_BUILD_TYPE=Release`
2. Run `cmake --build build --config Release`
3. Verify no compilation errors

The table creator should compile successfully. It uses:
- DuckDB's Connection class for query execution
- gdpdu_schema.hpp structures (TableDef, ColumnDef)
- gdpdu_type_to_duckdb_type() helper function
  </action>
  <verify>cmake --build build --config Release completes without errors</verify>
  <done>Build includes table creator; extension compiles successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/gdpdu_table_creator.hpp exists with create_tables declaration
- [ ] src/gdpdu_table_creator.cpp exists with full implementation
- [ ] generate_create_table_sql produces valid SQL with quoted identifiers
- [ ] create_table executes DROP TABLE IF EXISTS before CREATE
- [ ] cmake --build build completes without errors
- [ ] Column types are generated using gdpdu_type_to_duckdb_type
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Table creator module ready for integration with parser
- Tables would be created with correct structure if called with valid schema
</success_criteria>

<output>
After completion, create `.planning/phases/03-table-creation/03-01-SUMMARY.md`
</output>
