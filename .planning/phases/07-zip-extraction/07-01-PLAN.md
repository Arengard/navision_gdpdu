---
phase: 07-zip-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/include/zip_extractor.hpp
  - src/zip_extractor.cpp
  - src/CMakeLists.txt
autonomous: true
must_haves:
  truths:
    - "Extension extracts index.xml and .txt files from a zip archive to a temp directory"
    - "Extracted files are accessible at known paths for import processing"
    - "Temporary extraction directories are cleaned up after use (success or failure)"
    - "Extraction errors (corrupt zip, missing files) are caught and reported via result struct"
  artifacts:
    - path: "src/include/zip_extractor.hpp"
      provides: "ZipExtractResult struct and extract_zip function declaration"
      contains: "ZipExtractResult"
    - path: "src/zip_extractor.cpp"
      provides: "Zip extraction implementation using duckdb_miniz"
      contains: "mz_zip_reader"
    - path: "src/CMakeLists.txt"
      provides: "Build integration for zip_extractor.cpp"
      contains: "zip_extractor.cpp"
  key_links:
    - from: "src/zip_extractor.cpp"
      to: "duckdb_miniz::mz_zip_reader_init_file"
      via: "miniz ZIP archive API"
      pattern: "mz_zip_reader_init_file"
    - from: "src/zip_extractor.cpp"
      to: "src/include/webdav_client.hpp"
      via: "uses create_temp_download_dir for temp directory creation"
      pattern: "create_temp_download_dir"
---

<objective>
Implement zip extraction module that extracts GDPdU exports (index.xml + data files) from downloaded zip archives to temporary directories, using DuckDB's bundled miniz library.

Purpose: Phase 7 bridges Phase 6 (WebDAV download of zips) and Phase 8 (batch import). Downloaded zips contain complete GDPdU exports that must be extracted before the existing gdpdu_importer can process them.

Output: zip_extractor.hpp/cpp module providing extract_zip() function that takes a zip file path, extracts all contents to a temp directory, and returns the extraction path (or error). Follows the same result struct pattern established in Phase 6.
</objective>

<execution_context>
@C:/Users/Ramon.Ljevo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Ramon.Ljevo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-webdav-client/06-01-SUMMARY.md
@src/include/webdav_client.hpp
@src/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement zip extractor module with miniz</name>
  <files>src/include/zip_extractor.hpp, src/zip_extractor.cpp</files>
  <action>
Create zip_extractor.hpp with:
- ZipExtractResult struct: { bool success; string error_message; string extract_dir; vector<string> extracted_files; }
- Function declaration: ZipExtractResult extract_zip(const string& zip_path);
- Function declaration: void cleanup_extract_dir(const string& dir_path); (delegates to cleanup_temp_dir from webdav_client.hpp)

Create zip_extractor.cpp with:
- Include "miniz.hpp" for duckdb_miniz ZIP archive API (already available via DuckDB's include paths to third_party/miniz)
- Include "webdav_client.hpp" to reuse create_temp_download_dir() for temp directory creation
- extract_zip() implementation:
  1. Create temp extraction directory using create_temp_download_dir() (already proven in Phase 6)
  2. Open zip with duckdb_miniz::mz_zip_reader_init_file()
  3. Iterate entries with mz_zip_reader_get_num_files() and mz_zip_reader_file_stat()
  4. Skip directory entries (check mz_zip_reader_is_file_a_directory())
  5. For each file: extract to temp dir using mz_zip_reader_extract_to_file()
  6. Handle nested directory structure inside zip -- create subdirectories as needed using platform-specific mkdir
  7. Collect list of extracted file paths in extracted_files vector
  8. On any error: clean up partially extracted files, return error in result struct
  9. On success: return extract_dir path and list of extracted files
  10. Wrap everything in try/catch, never throw exceptions (matches Phase 6 error handling pattern)
- cleanup_extract_dir() implementation: delegates to cleanup_temp_dir() from webdav_client.hpp
- All miniz calls use duckdb_miniz:: namespace prefix
- Remember to call mz_zip_reader_end() to close the archive (even on error paths)

Platform notes:
- Use _mkdir on Windows, mkdir on Unix for subdirectory creation (same pattern as webdav_client.cpp)
- Path separator handling: normalize to forward slashes internally, use platform separator for filesystem ops
  </action>
  <verify>Files src/include/zip_extractor.hpp and src/zip_extractor.cpp exist. Header declares ZipExtractResult, extract_zip, and cleanup_extract_dir. Implementation includes miniz.hpp and uses duckdb_miniz:: namespace. All error paths return result structs (no thrown exceptions). mz_zip_reader_end() is called in all code paths.</verify>
  <done>zip_extractor module created with extract_zip() that opens a zip file via miniz, extracts all contents to a temp directory, returns the extraction path and file list via ZipExtractResult struct, and handles all errors gracefully via result struct pattern.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate zip extractor into build system</name>
  <files>src/CMakeLists.txt</files>
  <action>
Add zip_extractor.cpp to the EXTENSION_SOURCES list in src/CMakeLists.txt, after webdav_client.cpp (maintaining logical ordering of Phase 6 then Phase 7 code).

The miniz library is already linked through DuckDB's build system (duckdb_miniz is linked to the duckdb target, and extensions inherit DuckDB's include paths). No additional target_link_libraries needed -- the include path to third_party/miniz is already set by DuckDB's CMakeLists.txt (line 679: include_directories(third_party/miniz)).

Verify the EXTENSION_SOURCES list is syntactically correct after modification.
  </action>
  <verify>src/CMakeLists.txt contains zip_extractor.cpp in EXTENSION_SOURCES. The file is syntactically valid CMake. Commit changes and push to trigger CI build.</verify>
  <done>zip_extractor.cpp is part of the build. CI pipeline can compile the extension with the new module.</done>
</task>

</tasks>

<verification>
1. src/include/zip_extractor.hpp exists and declares ZipExtractResult struct with success, error_message, extract_dir, extracted_files fields
2. src/include/zip_extractor.hpp declares extract_zip() and cleanup_extract_dir() functions
3. src/zip_extractor.cpp includes "miniz.hpp" and uses duckdb_miniz:: namespace for ZIP operations
4. src/zip_extractor.cpp includes "webdav_client.hpp" and reuses create_temp_download_dir()
5. extract_zip() creates temp dir, opens zip, iterates entries, extracts files, returns result
6. All error paths return ZipExtractResult with success=false (no exceptions thrown)
7. mz_zip_reader_end() called in all code paths (success and error)
8. zip_extractor.cpp listed in src/CMakeLists.txt EXTENSION_SOURCES
9. ZIP-01 requirement satisfied: extracts index.xml + .txt files from zip
10. ZIP-02 requirement satisfied: cleanup_extract_dir() removes temp files
</verification>

<success_criteria>
- ZipExtractResult struct provides success/error/path/file-list information
- extract_zip() successfully opens a zip file using duckdb_miniz API
- Files are extracted to a unique temporary directory
- Nested zip directory structures are handled (subdirs created as needed)
- cleanup_extract_dir() removes extraction directory and all contents
- Error handling follows result struct pattern (no exceptions)
- Module compiles as part of extension (CI build passes)
</success_criteria>

<output>
After completion, create `.planning/phases/07-zip-extraction/07-01-SUMMARY.md`
</output>
