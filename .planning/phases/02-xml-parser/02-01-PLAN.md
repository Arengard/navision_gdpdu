---
phase: 02-xml-parser
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/gdpdu_schema.hpp, src/gdpdu_schema.cpp, src/CMakeLists.txt, CMakeLists.txt]
autonomous: true

must_haves:
  truths:
    - "TableDef struct holds table metadata (name, URL, columns, primary keys)"
    - "ColumnDef struct holds column metadata (name, type, precision)"
    - "GDPdU types (AlphaNumeric, Numeric, Date) are represented as enum"
    - "pugixml is linked and available for use in extension"
  artifacts:
    - path: "src/gdpdu_schema.hpp"
      provides: "Schema data structures for GDPdU tables and columns"
      min_lines: 40
      contains: "struct TableDef"
    - path: "src/gdpdu_schema.cpp"
      provides: "Schema structure implementations and helper functions"
      min_lines: 20
    - path: "src/CMakeLists.txt"
      provides: "Extension source file list with pugixml linkage"
      contains: "pugixml"
  key_links:
    - from: "src/gdpdu_schema.hpp"
      to: "src/gdpdu_schema.cpp"
      via: "implementation of declared structures"
    - from: "CMakeLists.txt"
      to: "pugixml"
      via: "FetchContent and target_link_libraries"
---

<objective>
Create the foundational data structures for representing GDPdU schema definitions.

Purpose: Define C++ structs that capture all metadata from index.xml table definitions — these structures will be populated by the parser (Plan 02) and consumed by table creation (Phase 3).

Output: Schema header/source files with TableDef, ColumnDef, and GdpduType; CMake configured to link pugixml.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Relevant source files:
@src/gdpdu_extension.cpp
@src/include/gdpdu_extension.hpp
@CMakeLists.txt
@src/CMakeLists.txt

Sample data for reference:
@Gdpdu Data/index.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GDPdU schema data structures</name>
  <files>src/gdpdu_schema.hpp, src/gdpdu_schema.cpp</files>
  <action>
Create schema data structures that capture all metadata from GDPdU index.xml.

**src/gdpdu_schema.hpp**:

1. Define `GdpduType` enum:
   ```cpp
   enum class GdpduType {
       AlphaNumeric,  // Maps to VARCHAR
       Numeric,       // Maps to DECIMAL(precision, scale)
       Date           // Maps to DATE
   };
   ```

2. Define `ColumnDef` struct:
   ```cpp
   struct ColumnDef {
       std::string name;           // From <Name> element
       GdpduType type;             // AlphaNumeric, Numeric, or Date
       int precision;              // From <Accuracy> element, 0 if not specified
       bool is_primary_key;        // true if from VariablePrimaryKey
   };
   ```

3. Define `TableDef` struct:
   ```cpp
   struct TableDef {
       std::string name;           // From Table/Name element
       std::string url;            // From Table/URL element (data file path)
       std::string description;    // From Table/Description element
       bool is_utf8;               // true if UTF8 element present
       char decimal_symbol;        // From DecimalSymbol (default ',')
       char digit_grouping;        // From DigitGroupingSymbol (default '.')
       std::vector<ColumnDef> columns;  // All columns in order
       std::vector<std::string> primary_key_columns;  // Names of PK columns
   };
   ```

4. Define `GdpduSchema` struct to hold all tables:
   ```cpp
   struct GdpduSchema {
       std::string media_name;     // From Media/Name
       std::vector<TableDef> tables;
   };
   ```

5. Add helper function declarations:
   - `std::string gdpdu_type_to_string(GdpduType type)` - for debugging
   - `std::string gdpdu_type_to_duckdb_type(const ColumnDef& col)` - for Phase 3

**src/gdpdu_schema.cpp**:

Implement the helper functions:
- `gdpdu_type_to_string`: Return "AlphaNumeric", "Numeric", or "Date"
- `gdpdu_type_to_duckdb_type`: 
  - AlphaNumeric → "VARCHAR"
  - Numeric with precision → "DECIMAL(precision, precision)" (use precision for both scale and precision as GDPdU Accuracy represents decimal places)
  - Numeric without precision → "BIGINT" (integer)
  - Date → "DATE"

Include necessary headers: `<string>`, `<vector>`.
  </action>
  <verify>Files exist and compile: check syntax by including in a test build</verify>
  <done>Schema structures defined with all required fields; helper functions implemented</done>
</task>

<task type="auto">
  <name>Task 2: Configure CMake to link pugixml</name>
  <files>src/CMakeLists.txt, CMakeLists.txt</files>
  <action>
Update CMake configuration to properly link pugixml and include the new source files.

**CMakeLists.txt** (root):
- pugixml is already fetched via FetchContent (good!)
- No changes needed to root CMakeLists.txt if FetchContent is working

**src/CMakeLists.txt**:
If this file doesn't exist or is minimal, create/update it to:

1. Define extension sources:
   ```cmake
   set(EXTENSION_SOURCES
       gdpdu_extension.cpp
       gdpdu_schema.cpp
   )
   ```

2. If using DuckDB extension build system, ensure the gdpdu extension target links pugixml:
   ```cmake
   # After extension is defined, link pugixml
   target_link_libraries(gdpdu_extension PRIVATE pugixml)
   target_include_directories(gdpdu_extension PRIVATE ${CMAKE_SOURCE_DIR}/src/include)
   ```

**Verify pugixml integration:**
- Check that `#include <pugixml.hpp>` works in a source file
- The pugixml FetchContent in root CMakeLists.txt should make it available

If the DuckDB extension build system handles sources differently (via extension_config.cmake), update that file instead to include the new source files.
  </action>
  <verify>cmake -B build -DCMAKE_BUILD_TYPE=Release succeeds without errors</verify>
  <done>CMake configures successfully; pugixml is linkable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/gdpdu_schema.hpp exists with TableDef, ColumnDef, GdpduType
- [ ] src/gdpdu_schema.cpp exists with helper function implementations
- [ ] cmake -B build completes without errors
- [ ] Build includes new source files
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Schema structures ready for parser implementation
- pugixml available for XML parsing
</success_criteria>

<output>
After completion, create `.planning/phases/02-xml-parser/02-01-SUMMARY.md`
</output>
