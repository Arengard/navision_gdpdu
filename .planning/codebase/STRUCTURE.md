# Codebase Structure

**Analysis Date:** 2026-01-24

## Directory Layout

```
navision_gdpdu/
├── CMakeLists.txt              # CMake build configuration (DuckDB, pugixml)
├── Makefile                    # Build targets (configure, release, debug, clean, test)
├── extension_config.cmake      # Extension configuration for DuckDB build system
├── README.md                   # User documentation
├── vcpkg.json                  # vcpkg package manager metadata
├── .github/                    # GitHub workflows (CI/CD)
├── .planning/                  # GSD planning documents
│   └── codebase/              # Architecture/convention docs (generated)
└── src/                        # Main source code
    ├── include/               # Header files (.hpp)
    │   ├── gdpdu_extension.hpp
    │   ├── gdpdu_importer.hpp
    │   ├── gdpdu_parser.hpp
    │   ├── gdpdu_schema.hpp
    │   ├── gdpdu_table_creator.hpp
    │   └── gdpdu_data_parser.hpp
    ├── gdpdu_extension.cpp
    ├── gdpdu_importer.cpp
    ├── gdpdu_parser.cpp
    ├── gdpdu_schema.cpp
    ├── gdpdu_table_creator.cpp
    └── gdpdu_data_parser.cpp
```

## Directory Purposes

**`src/`:**
- Purpose: All C++ source code for the extension
- Contains: Implementation (.cpp) and header (.hpp) files
- Key files: Entry point in `gdpdu_extension.cpp`, orchestration in `gdpdu_importer.cpp`

**`src/include/`:**
- Purpose: Header files defining interfaces and data structures
- Contains: Abstract classes, structs, function declarations
- Pattern: Each .cpp has corresponding .hpp in include/

**`.planning/codebase/`:**
- Purpose: Architecture and convention documentation (generated by GSD)
- Generated: Yes (write-only)
- Committed: Yes

## Key File Locations

**Entry Points:**

- `src/gdpdu_extension.cpp` (line 163-169): `DUCKDB_CPP_EXTENSION_ENTRY` - DuckDB calls this to load extension
- `src/gdpdu_extension.cpp` (line 30-59): `GdpduImportBind()` - DuckDB calls to bind SQL function arguments
- `src/gdpdu_extension.cpp` (line 62-80): `GdpduImportInit()` - DuckDB calls to initialize state and run import
- `src/gdpdu_extension.cpp` (line 83-113): `GdpduImportScan()` - DuckDB calls to stream result rows

**Configuration:**

- `CMakeLists.txt`: DuckDB version (v1.4.3), pugixml version (v1.14), build options
- `extension_config.cmake`: Tells DuckDB build system where to find our extension
- `Makefile`: Build commands (make release, make debug, make clean)

**Core Logic:**

- `src/gdpdu_importer.cpp`: Three-phase import orchestration (parse → create → load)
- `src/gdpdu_parser.cpp`: index.xml parsing and schema extraction
- `src/gdpdu_table_creator.cpp`: CREATE TABLE SQL generation and execution
- `src/gdpdu_data_parser.cpp`: CSV line parsing and type conversion (currently unused in main path)

**Schema/Type System:**

- `src/gdpdu_schema.cpp`: Type conversion functions, enum helpers
- `src/include/gdpdu_schema.hpp`: ColumnDef, TableDef, GdpduSchema, GdpduType enum

**Testing:**

- Not yet present (Makefile has placeholder test target)

## Naming Conventions

**Files:**
- Pattern: `gdpdu_[component].cpp` and `gdpdu_[component].hpp`
- Example: `gdpdu_parser.cpp`, `gdpdu_table_creator.hpp`

**Directories:**
- Pattern: Single `src/` directory with `include/` subdirectory
- Headers separate from implementation (not co-located)

**Classes:**
- Pattern: PascalCase
- Example: `GdpduExtension`, `GdpduDataParser`

**Functions:**
- Pattern: snake_case for static utilities, PascalCase for class methods
- Example: `parse_index_xml()`, `to_snake_case()`, `GdpduDataParser::parse_line()`

**Variables:**
- Pattern: snake_case
- Example: `directory_path`, `column_name_field`, `current_row`

**Structs/Data Classes:**
- Pattern: PascalCase with `Def` suffix for type definitions, `Result` suffix for output structures
- Example: `ColumnDef`, `TableDef`, `ImportResult`, `DataParseResult`

## Where to Add New Code

**New Feature (e.g., new import mode):**
- Primary code: `src/gdpdu_importer.cpp` - add new orchestration function alongside `import_gdpdu()`
- Extension registration: `src/gdpdu_extension.cpp` - add new table function overload to GdpduExtension::Load()
- Headers: Update `src/include/gdpdu_importer.hpp` with new function declaration

**New Parser/Converter (e.g., support for new data format):**
- Implementation: `src/gdpdu_data_parser.cpp` - add new static methods to `GdpduDataParser` class
- Headers: Declare in `src/include/gdpdu_data_parser.hpp`
- Usage: Call from appropriate layer (importer or table creator)

**New Type Support (e.g., new GDPdU data type):**
- Enum: Add to `GdpduType` in `src/include/gdpdu_schema.hpp`
- Type mapping: Add case to `gdpdu_type_to_duckdb_type()` in `src/gdpdu_schema.cpp`
- Parser support: Update `parse_column()` in `src/gdpdu_parser.cpp` to recognize new XML type element
- Data conversion: Add case to `convert_field()` in `src/gdpdu_data_parser.cpp`

**Bug Fix/Refactor:**
- Identify layer (parsing, schema, creation, loading)
- Make changes in corresponding .cpp/.hpp pair
- Test integration through extension entry point

## Special Directories

**`.github/`:**
- Purpose: GitHub workflows for CI/CD
- Generated: No
- Committed: Yes
- Contains: GitHub Actions configuration

**`build/`:**
- Purpose: CMake build output (created by `make release` or `make debug`)
- Generated: Yes
- Committed: No (in .gitignore)
- Created by: CMake during build

## Dependencies

**External:**
- DuckDB v1.4.3 (fetched via CMakeFiles FetchContent)
- pugixml v1.14 (fetched via CMake FetchContent)

**Internal Layering:**
```
gdpdu_extension.cpp
  → gdpdu_importer.cpp
      → gdpdu_parser.cpp
          → pugixml (external)
      → gdpdu_table_creator.cpp
      → gdpdu_data_parser.cpp (optional, used for validation)
      → DuckDB connection (external)
```

## Header Include Patterns

**Extension layer** (`gdpdu_extension.cpp`):
```cpp
#include "gdpdu_extension.hpp"
#include "gdpdu_importer.hpp"
#include "duckdb.hpp"
#include "duckdb/main/extension.hpp"
#include "duckdb/function/table_function.hpp"
```

**Parser layer** (`gdpdu_parser.cpp`):
```cpp
#include "gdpdu_parser.hpp"
#include "gdpdu_schema.hpp"
#include <pugixml.hpp>
#include <algorithm>
#include <cctype>
```

**Importer layer** (`gdpdu_importer.cpp`):
```cpp
#include "gdpdu_importer.hpp"
#include "gdpdu_parser.hpp"
#include "gdpdu_table_creator.hpp"
```

Pattern: Each module includes its own header first, then dependencies

## Build System

**CMake Configuration:**
- Minimum version: 3.12
- C++ standard: C++11
- Build types: Release (optimized), Debug (symbols)

**Build Targets:**
- `make release` - optimized build
- `make debug` - debug build with symbols
- `make clean` - remove build/ directory
- `make configure` - run CMake
- `make test` - placeholder (no tests yet)

**Extension Registration:**
- DuckDB extension name: `gdpdu`
- Functions registered: `gdpdu_import` (two overloads: 1-arg and 2-arg)
- Entry point: `DUCKDB_CPP_EXTENSION_ENTRY` macro in `src/gdpdu_extension.cpp`

---

*Structure analysis: 2026-01-24*
